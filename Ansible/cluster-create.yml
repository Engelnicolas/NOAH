---
- name: Create NOAH Kubernetes Cluster
  hosts: local
  gather_facts: yes
  vars:
    cluster_name: "noah-cluster"
    verbose_mode: true  # Enable verbose output by default
    
  tasks:
    - name: "LOAD CONFIGURATION: Read environment variables from .env file"
      ansible.builtin.shell: |
        # Load .env file and export variables
        if [ -f "/root/NOAH/.env" ]; then
          export $(grep -v '^#' /root/NOAH/.env | xargs)
          echo "NOAH_ROOT_DIR=${NOAH_ROOT_DIR:-/root/NOAH}"
          echo "NOAH_SCRIPTS_DIR=${NOAH_SCRIPTS_DIR:-./Scripts}"
          echo "NOAH_CERTIFICATES_DIR=${NOAH_CERTIFICATES_DIR:-./Certificates}"
          echo "NOAH_AGE_DIR=${NOAH_AGE_DIR:-./Age}"
          echo "NOAH_VENV_DIR=${NOAH_VENV_DIR:-./.venv}"
          echo "SOPS_CONFIG_FILE=${SOPS_CONFIG_FILE:-.sops.yaml}"
        else
          echo "ERROR: .env file not found at /root/NOAH/.env"
          exit 1
        fi
      register: env_vars
      changed_when: false
      
    - name: "LOAD CONFIGURATION: Set environment variables as Ansible facts"
      ansible.builtin.set_fact:
        noah_root_dir: "{{ env_vars.stdout_lines | select('match', '^NOAH_ROOT_DIR=') | first | regex_replace('^NOAH_ROOT_DIR=', '') }}"
        noah_scripts_dir: "{{ env_vars.stdout_lines | select('match', '^NOAH_SCRIPTS_DIR=') | first | regex_replace('^NOAH_SCRIPTS_DIR=', '') }}"
        noah_certificates_dir: "{{ env_vars.stdout_lines | select('match', '^NOAH_CERTIFICATES_DIR=') | first | regex_replace('^NOAH_CERTIFICATES_DIR=', '') }}"
        noah_age_dir: "{{ env_vars.stdout_lines | select('match', '^NOAH_AGE_DIR=') | first | regex_replace('^NOAH_AGE_DIR=', '') }}"
        noah_venv_dir: "{{ env_vars.stdout_lines | select('match', '^NOAH_VENV_DIR=') | first | regex_replace('^NOAH_VENV_DIR=', '') }}"
        sops_config_file: "{{ env_vars.stdout_lines | select('match', '^SOPS_CONFIG_FILE=') | first | regex_replace('^SOPS_CONFIG_FILE=', '') }}"

    - name: "CONFIGURATION: Display loaded paths"
      ansible.builtin.debug:
        msg: |
          === NOAH PATH CONFIGURATION ===
          Root Directory: {{ noah_root_dir }}
          Scripts Directory: {{ noah_scripts_dir }}
          Certificates Directory: {{ noah_certificates_dir }}
          Age Directory: {{ noah_age_dir }}
          Virtual Environment: {{ noah_venv_dir }}
          SOPS Config File: {{ sops_config_file }}
          ===============================

    - name: "PREREQUISITE: Validate cluster is clean before creation"
      ansible.builtin.shell: |
        echo "=== VALIDATING CLEAN CLUSTER STATE ==="
        
        # Check for existing K3s processes
        if pgrep -f k3s >/dev/null 2>&1; then
          echo "ERROR: K3s processes are still running. Run 'python noah.py cluster destroy' first."
          exit 1
        fi
        
        # Check for existing K3s service
        if systemctl is-active k3s >/dev/null 2>&1; then
          echo "ERROR: K3s service is still active. Run 'python noah.py cluster destroy' first."
          exit 1
        fi
        
        # Check for existing kubectl context
        if kubectl cluster-info >/dev/null 2>&1; then
          echo "ERROR: Existing cluster is accessible. Run 'python noah.py cluster destroy' first."
          exit 1
        fi
        
        # Check for existing Helm releases
        if command -v helm >/dev/null 2>&1; then
          if helm list --all-namespaces -o json 2>/dev/null | jq -e '. | length > 0' >/dev/null; then
            echo "ERROR: Existing Helm releases found. Run 'python noah.py cluster destroy' first."
            exit 1
          fi
        fi
        
        # Check for existing NOAH data directories
        for dir in "/var/lib/rancher/k3s" "/etc/rancher/k3s" "/run/k3s"; do
          if [ -d "$dir" ]; then
            echo "ERROR: K3s data directory exists: $dir. Run 'python noah.py cluster destroy' first."
            exit 1
          fi
        done
        
        echo "‚úì No existing cluster components found"
        echo "‚úì System is clean and ready for cluster creation"
        echo "=== PREREQUISITE VALIDATION PASSED ==="
      ignore_errors: false
      changed_when: false

    - name: Ensure basic system packages are installed
      package:
        name: "{{ item }}"
        state: present
      loop:
        - age
        - python3
        - python3-pip
        - python3-venv
        - curl
        - git
      become: yes
      when: ansible_os_family == "Debian"

    - name: Check if kubectl is installed
      command: which kubectl
      register: kubectl_check
      failed_when: false
      changed_when: false

    - name: Check if helm is installed
      command: which helm
      register: helm_check
      failed_when: false
      changed_when: false

    - name: Check if sops is installed
      command: which sops
      register: sops_check
      failed_when: false
      changed_when: false

    - name: Display tool availability status
      debug:
        msg:
          - "kubectl available: {{ kubectl_check.rc == 0 }}"
          - "helm available: {{ helm_check.rc == 0 }}"
          - "sops available: {{ sops_check.rc == 0 }}"
          - "age available: {{ 'yes' if ansible_facts.packages is defined and 'age' in ansible_facts.packages else 'unknown' }}"

    - name: Check if virtual environment exists
      stat:
        path: "{{ noah_root_dir }}/{{ noah_venv_dir }}"
      register: venv_exists

    - name: Create Python virtual environment
      command: python3 -m venv {{ noah_venv_dir }}
      args:
        chdir: "{{ noah_root_dir }}"
      when: not venv_exists.stat.exists

    - name: Install Python dependencies from Scripts/requirements.txt
      shell: |
        {{ noah_venv_dir }}/bin/python -m pip install --upgrade pip
        {{ noah_venv_dir }}/bin/python -m pip install packaging
        {{ noah_venv_dir }}/bin/python -m pip install -r {{ noah_scripts_dir }}/requirements.txt
      args:
        chdir: "{{ noah_root_dir }}"
        creates: "{{ noah_root_dir }}/{{ noah_venv_dir }}/lib/python*/site-packages/click"
      register: pip_install_result

    - name: Verify NOAH CLI functionality
      shell: |
        export PYTHONPATH=$(pwd):$PYTHONPATH
        {{ noah_venv_dir }}/bin/python noah.py --help
      args:
        chdir: "{{ noah_root_dir }}"
      register: noah_cli_test
      failed_when: noah_cli_test.rc != 0

    - name: Display NOAH CLI verification result
      debug:
        msg: "NOAH CLI is functional and ready for deployment"
      when: noah_cli_test.rc == 0

    - name: Create cluster namespaces
      kubernetes.core.k8s:
        name: "{{ item }}"
        api_version: v1
        kind: Namespace
        state: present
      loop:
        - identity
        - cilium-system
      when: false  # Skip in test mode

    - name: Initialize Age encryption
      shell: |
        if [ ! -f {{ noah_age_dir }}/keys.txt ]; then
          mkdir -p {{ noah_age_dir }}
          age-keygen > {{ noah_age_dir }}/keys.txt
          chmod 600 {{ noah_age_dir }}/keys.txt
        fi
      args:
        chdir: "{{ noah_root_dir }}"
        creates: "{{ noah_root_dir }}/{{ noah_age_dir }}/keys.txt"

    - name: Extract Age public key
      shell: grep "public key:" {{ noah_age_dir }}/keys.txt | cut -d' ' -f4
      args:
        chdir: "{{ noah_root_dir }}"
      register: age_public_key
      changed_when: false

    - name: Create SOPS configuration
      copy:
        content: |
          creation_rules:
            - path_regex: .*\.enc\.yaml$
              age: {{ age_public_key.stdout }}
            - path_regex: .*\.enc\.json$
              age: {{ age_public_key.stdout }}
        dest: "{{ noah_root_dir }}/{{ sops_config_file }}"
        mode: '0644'

    - name: Generate self-signed CA certificate
      block:
        - name: Create certificate directory
          file:
            path: "{{ noah_root_dir }}/{{ noah_certificates_dir }}"
            state: directory
            mode: '0755'

        - name: Generate CA private key with OpenSSL command
          shell: |
            if [ ! -f {{ noah_certificates_dir }}/ca.key ]; then
              openssl genrsa -out {{ noah_certificates_dir }}/ca.key 4096
              chmod 600 {{ noah_certificates_dir }}/ca.key
            fi
          args:
            chdir: "{{ noah_root_dir }}"
            creates: "{{ noah_root_dir }}/{{ noah_certificates_dir }}/ca.key"

        - name: Generate self-signed CA certificate with OpenSSL command
          shell: |
            if [ ! -f {{ noah_certificates_dir }}/ca.crt ]; then
              openssl req -new -x509 -key {{ noah_certificates_dir }}/ca.key -sha256 -subj "/C=US/ST=CA/O=NOAH/CN=NOAH CA" -days 3650 -out {{ noah_certificates_dir }}/ca.crt
              chmod 644 {{ noah_certificates_dir }}/ca.crt
            fi
          args:
            chdir: "{{ noah_root_dir }}"
            creates: "{{ noah_root_dir }}/{{ noah_certificates_dir }}/ca.crt"

    - name: Install K3s Kubernetes cluster
      block:
        - name: Download and install K3s
          shell: |
            curl -sfL https://get.k3s.io | sh -s - \
              --write-kubeconfig-mode 644 \
              --disable traefik \
              --disable servicelb \
              --disable local-storage \
              --cluster-init
          environment:
            INSTALL_K3S_EXEC: "server"
          become: yes
          
        - name: Wait for K3s to be ready
          shell: |
            timeout=300
            start_time=$(date +%s)
            
            # Set kubeconfig for kubectl to work
            export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
            
            while true; do
              current_time=$(date +%s)
              elapsed=$((current_time - start_time))
              
              if [ $elapsed -gt $timeout ]; then
                echo "ERROR: K3s startup timeout after ${timeout}s"
                exit 1
              fi
              
              if kubectl get nodes >/dev/null 2>&1; then
                echo "‚úì K3s is ready"
                kubectl get nodes
                break
              fi
              
              echo "Waiting for K3s to start... (${elapsed}s elapsed)"
              sleep 5
            done
          register: k3s_ready
          
        - name: Setup persistent kubectl access
          shell: |
            echo "=== SETTING UP PERSISTENT KUBECTL ACCESS ==="
            
            # Create .kube directory for root user
            mkdir -p /root/.kube
            
            # Copy K3s kubeconfig to standard location
            cp /etc/rancher/k3s/k3s.yaml /root/.kube/config
            
            # Set proper ownership and permissions
            chown root:root /root/.kube/config
            chmod 600 /root/.kube/config
            
            # Add KUBECONFIG to shell profiles for persistent access
            echo "# NOAH K3s kubectl configuration" >> /root/.bashrc
            echo "export KUBECONFIG=/root/.kube/config" >> /root/.bashrc
            
            # Also add to .profile for login shells
            echo "# NOAH K3s kubectl configuration" >> /root/.profile
            echo "export KUBECONFIG=/root/.kube/config" >> /root/.profile
            
            # Set KUBECONFIG for current session
            export KUBECONFIG=/root/.kube/config
            
            # Verify kubectl works with new config
            kubectl cluster-info
            kubectl get nodes
            
            echo "‚úì Persistent kubectl access configured"
            echo "‚úì KUBECONFIG set to: /root/.kube/config"
            echo "‚úì Configuration will persist across sessions"
          register: kubectl_setup
          
        - name: Create cluster namespaces
          kubernetes.core.k8s:
            name: "{{ item }}"
            api_version: v1
            kind: Namespace
            state: present
          loop:
            - identity
            - cilium-system

    - name: Display cluster creation summary
      debug:
        msg:
          - "Cluster {{ cluster_name }} initialized successfully"
          - "Python virtual environment: {{ noah_venv_dir }} created"
          - "NOAH dependencies installed from {{ noah_scripts_dir }}/requirements.txt"
          - "NOAH CLI verified and functional"
          - "Age public key: {{ age_public_key.stdout }}"
          - "Namespaces created: identity, cilium-system"
          - "CA certificate generated in {{ noah_certificates_dir }}"
          - "kubectl configured for persistent access (/root/.kube/config)"
          - "KUBECONFIG environment variable configured in shell profiles"
          - "Cluster ready for NOAH service deployment"

    - name: "FINAL VALIDATION: Run NOAH setup doctor for comprehensive prerequisite check"
      ansible.builtin.shell: |
        echo ""
        echo "=============================================="
        echo "    NOAH CLUSTER CREATION VALIDATION TEST    "
        echo "=============================================="
        echo ""
        echo "[VALIDATION] Running comprehensive NOAH environment check..."
        echo ""
        
        # Set the environment for NOAH CLI
        export PYTHONPATH=$(pwd):$PYTHONPATH
        
        # Load environment variables
        export $(grep -v '^#' .env | xargs)
        NOAH_VENV_DIR=${NOAH_VENV_DIR:-./.venv}
        NOAH_AGE_DIR=${NOAH_AGE_DIR:-./Age}
        NOAH_CERTIFICATES_DIR=${NOAH_CERTIFICATES_DIR:-./Certificates}
        SOPS_CONFIG_FILE=${SOPS_CONFIG_FILE:-.sops.yaml}
        
        # Run noah.py setup doctor and capture output
        if ${NOAH_VENV_DIR}/bin/python noah.py setup doctor; then
          echo ""
          echo "‚úÖ NOAH setup doctor validation PASSED"
          doctor_status="PASS"
        else
          echo ""
          echo "‚ùå NOAH setup doctor validation FAILED"
          doctor_status="FAIL"
        fi
        
        echo ""
        echo "[VALIDATION] Additional cluster-specific checks..."
        
        # Check kubectl persistent access
        echo ""
        echo "[KUBECTL] Validating persistent kubectl configuration..."
        if [ -f "/root/.kube/config" ]; then
          echo "‚úÖ kubectl config file: PRESENT (/root/.kube/config)"
          
          # Test kubectl connectivity without explicit KUBECONFIG
          unset KUBECONFIG  # Clear any temporary KUBECONFIG
          if kubectl cluster-info >/dev/null 2>&1; then
            echo "‚úÖ kubectl connectivity: WORKING (persistent access confirmed)"
            kubectl_status="PASS"
          else
            echo "‚ùå kubectl connectivity: FAILED (persistent access not working)"
            kubectl_status="FAIL"
          fi
          
          # Check if KUBECONFIG is in shell profiles
          if grep -q "KUBECONFIG=/root/.kube/config" /root/.bashrc; then
            echo "‚úÖ kubectl shell integration: CONFIGURED (.bashrc)"
          else
            echo "‚ùå kubectl shell integration: MISSING (.bashrc)"
            kubectl_status="FAIL"
          fi
        else
          echo "‚ùå kubectl config file: MISSING (/root/.kube/config)"
          kubectl_status="FAIL"
        fi
        
        # Check Age keys specifically
        if [ -f "${NOAH_AGE_DIR}/keys.txt" ]; then
          echo "‚úÖ Age encryption keys: PRESENT"
          age_status="PASS"
        else
          echo "‚ùå Age encryption keys: MISSING"
          age_status="FAIL"
        fi
        
        # Check SOPS configuration
        if [ -f "${SOPS_CONFIG_FILE}" ]; then
          echo "‚úÖ SOPS configuration: PRESENT"
          sops_status="PASS"
        else
          echo "‚ùå SOPS configuration: MISSING"
          sops_status="FAIL"
        fi
        
        # Check TLS certificates
        if [ -f "${NOAH_CERTIFICATES_DIR}/ca.crt" ] && [ -f "${NOAH_CERTIFICATES_DIR}/ca.key" ]; then
          echo "‚úÖ TLS certificates: PRESENT"
          certs_status="PASS"
        else
          echo "‚ùå TLS certificates: MISSING"
          certs_status="FAIL"
        fi
        
        # Check virtual environment
        if [ -d "${NOAH_VENV_DIR}" ] && [ -f "${NOAH_VENV_DIR}/bin/python" ]; then
          echo "‚úÖ Python virtual environment: PRESENT"
          venv_status="PASS"
        else
          echo "‚ùå Python virtual environment: MISSING"
          venv_status="FAIL"
        fi
        
        # Check NOAH CLI functionality
        if ${NOAH_VENV_DIR}/bin/python noah.py --help >/dev/null 2>&1; then
          echo "‚úÖ NOAH CLI functionality: WORKING"
          cli_status="PASS"
        else
          echo "‚ùå NOAH CLI functionality: BROKEN"
          cli_status="FAIL"
        fi
        
        # Check essential external tools
        tools_status="PASS"
        for tool in kubectl helm ansible age sops; do
          if command -v $tool >/dev/null 2>&1; then
            echo "‚úÖ $tool: AVAILABLE"
          else
            echo "‚ùå $tool: MISSING"
            tools_status="FAIL"
          fi
        done
        
        # Check Python dependencies
        echo ""
        echo "[VALIDATION] Checking critical Python dependencies..."
        deps_status="PASS"
        critical_deps="click kubernetes ansible PyYAML python-dotenv requests"
        for dep in $critical_deps; do
          if ${NOAH_VENV_DIR}/bin/python -c "import $dep" >/dev/null 2>&1; then
            echo "‚úÖ Python $dep: INSTALLED"
          else
            echo "‚ùå Python $dep: MISSING"
            deps_status="FAIL"
          fi
        done
        
        echo ""
        echo "=============================================="
        echo "           VALIDATION SUMMARY"
        echo "=============================================="
        
        # Count failures
        failures=0
        if [ "$doctor_status" = "FAIL" ]; then failures=$((failures + 1)); fi
        if [ "$age_status" = "FAIL" ]; then failures=$((failures + 1)); fi
        if [ "$sops_status" = "FAIL" ]; then failures=$((failures + 1)); fi
        if [ "$certs_status" = "FAIL" ]; then failures=$((failures + 1)); fi
        if [ "$venv_status" = "FAIL" ]; then failures=$((failures + 1)); fi
        if [ "$cli_status" = "FAIL" ]; then failures=$((failures + 1)); fi
        if [ "$tools_status" = "FAIL" ]; then failures=$((failures + 1)); fi
        if [ "$deps_status" = "FAIL" ]; then failures=$((failures + 1)); fi
        
        echo "Component Status Summary:"
        echo "‚îú‚îÄ‚îÄ NOAH Setup Doctor: $doctor_status"
        echo "‚îú‚îÄ‚îÄ Age Encryption Keys: $age_status"
        echo "‚îú‚îÄ‚îÄ SOPS Configuration: $sops_status" 
        echo "‚îú‚îÄ‚îÄ TLS Certificates: $certs_status"
        echo "‚îú‚îÄ‚îÄ Virtual Environment: $venv_status"
        echo "‚îú‚îÄ‚îÄ NOAH CLI: $cli_status"
        echo "‚îú‚îÄ‚îÄ External Tools: $tools_status"
        echo "‚îî‚îÄ‚îÄ Python Dependencies: $deps_status"
        echo ""
        
        if [ $failures -eq 0 ]; then
          echo "üéâ SUCCESS: All validation checks passed!"
          echo "‚úÖ NOAH cluster is ready for service deployment"
          echo ""
          echo "Next steps:"
          echo "1. Deploy services: python noah.py deploy all --domain {{ domain | default('noah-infra.com') }}"
          echo "2. Or deploy individually:"
          echo "   - python noah.py deploy samba4 --domain {{ domain | default('noah-infra.com') }}"
          echo "   - python noah.py deploy authentik --domain {{ domain | default('noah-infra.com') }}"
          echo "   - python noah.py deploy cilium --domain {{ domain | default('noah-infra.com') }}"
          echo "3. Test deployment: python noah.py test sso"
          echo "4. Check status: python noah.py status"
          echo ""
          exit 0
        else
          echo "‚ùå FAILURE: $failures validation check(s) failed"
          echo "‚ö†Ô∏è  Cluster creation incomplete - manual intervention required"
          echo ""
          echo "Troubleshooting steps:"
          echo "1. Review failed components above"
          echo "2. Run: python noah.py setup initialize"
          echo "3. Check dependencies: python noah.py setup doctor"
          echo "4. Verify file permissions in ${NOAH_AGE_DIR}/ and ${NOAH_CERTIFICATES_DIR}/ directories"
          echo "5. Ensure virtual environment is properly activated"
          echo ""
          exit 1
        fi
      args:
        chdir: "{{ noah_root_dir }}"
      register: comprehensive_validation
      failed_when: comprehensive_validation.rc != 0
